@model List<TpSignalR.Entidades.Partido>
@{
    ViewData["Title"] = "Promiedos - Resultados en Vivo";
}

<style>
    body {
        margin: 0;
        padding: 0;
        background-color: #0a3d29;
        color: #fff;
        font-family: 'Arial', sans-serif;
    }

    .user-container {
        min-height: 100vh;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .user-header {
        text-align: center;
        padding: 30px 20px;
        margin-bottom: 30px;
    }

        .user-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .user-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

    .live-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        background: #ff4444;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse-live 2s infinite;
    }

    @@keyframes pulse-live {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .matches-list {
        display: grid;
        gap: 15px;
    }

    .match-row {
        background: #0d4a33;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
        padding: 20px;
    }

        .match-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

    .match-main {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 20px;
    }

    .match-left,
    .match-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .match-left {
        justify-content: flex-end;
    }

    .match-right {
        justify-content: flex-start;
    }

    .match-center {
        display: flex;
        justify-content: center;
    }

    .cards-section {
        display: flex;
        gap: 3px;
        min-width: 60px;
        justify-content: flex-end;
    }

    .cards-section-right {
        justify-content: flex-start;
    }

    .card-indicator {
        width: 8px;
        height: 12px;
        border-radius: 2px;
    }

    .card-yellow {
        background: #ffd700;
        box-shadow: 0 0 4px rgba(255, 215, 0, 0.6);
    }

    .card-red {
        background: #ff0000;
        box-shadow: 0 0 4px rgba(255, 0, 0, 0.6);
    }

    .team-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .team-name {
        font-size: 1.2rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .team-logo {
        font-size: 1.3rem;
    }

    .score-display {
        font-size: 2.5rem;
        font-weight: 700;
        padding: 0 20px;
        white-space: nowrap;
        min-width: 140px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .score-separator {
        opacity: 0.5;
        margin: 0 12px;
    }

    .score-local,
    .score-visitante {
        display: inline-block;
        min-width: 35px;
        text-align: center;
    }

    .match-details {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 0;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        align-items: start;
    }

    .team-goals {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 15px;
    }

    .goals-divider {
        width: 1px;
        background: rgba(255, 255, 255, 0.2);
        align-self: stretch;
        margin: 0 10px;
    }

    .goals-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .goal-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        font-size: 0.8rem;
        white-space: nowrap;
        width: fit-content;
    }

    .goal-minute {
        color: #ffd700;
        font-weight: 600;
    }

    .goal-player {
        color: #e2e8f0;
    }

    .no-goals {
        color: rgba(255, 255, 255, 0.4);
        font-style: italic;
        font-size: 0.85rem;
    }

    .no-matches {
        text-align: center;
        padding: 80px 20px;
        color: rgba(255, 255, 255, 0.6);
    }

        .no-matches h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .no-matches p {
            font-size: 1.1rem;
        }

    /* Toast / Notificaci√≥n */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 9999;
        pointer-events: none;
    }

    .toast {
        min-width: 260px;
        max-width: 360px;
        background: rgba(17, 24, 39, 0.95);
        color: #fff;
        border-radius: 8px;
        padding: 12px 14px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        display: flex;
        gap: 10px;
        align-items: center;
        pointer-events: auto;
        opacity: 0;
        transform: translateY(-10px) scale(0.98);
        transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    .toast .icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-weight: 700;
        font-size: 18px;
    }

    .toast .content {
        flex: 1;
    }

    .toast .title {
        font-weight: 700;
        font-size: 0.95rem;
        margin-bottom: 4px;
    }

    .toast .message {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .toast.success .icon { background: rgba(34,197,94,0.15); color: #22c55e; }
    .toast.info .icon { background: rgba(59,130,246,0.12); color: #60a5fa; }
    .toast.warning .icon { background: rgba(245,158,11,0.12); color: #f59e0b; }

    @@media (max-width: 768px) {
        .match-main {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .match-left,
        .match-right {
            justify-content: center;
        }

        .cards-section {
            min-width: auto;
        }

        .score-display {
            font-size: 2rem;
            min-width: 100px;
        }

        .team-name {
            font-size: 1rem;
        }

        .match-details {
            grid-template-columns: 1fr;
            gap: 15px;
        }
    }
</style>

<div class="user-container">
    <!-- Toast container para notificaciones en vivo -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div class="user-header">
        <h1>‚öΩ Resultados en Vivo</h1>
        <p><span class="live-indicator"></span>Actualizaci√≥n en tiempo real</p>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="matches-list">
            @foreach (var partido in Model)
            {
                var golesLocal = partido.Goles?.Where(g => g.Equipo.ToLower() == "local").OrderBy(g => g.Minuto).ToList() ?? new List<TpSignalR.Entidades.Gol>();
                var golesVisitante = partido.Goles?.Where(g => g.Equipo.ToLower() == "visitante").OrderBy(g => g.Minuto).ToList() ?? new List<TpSignalR.Entidades.Gol>();

                <div class="match-row" data-partido-id="@partido.Id">
                    <div class="match-main">
                        <!-- Left side: Cards + Local Team -->
                        <div class="match-left">
                            <div class="cards-section cards-local">
                                @for (int i = 0; i < partido.RojasEquipoLocal; i++)
                                {
                                    <div class="card-indicator card-red"></div>
                                }
                                @for (int i = 0; i < partido.AmarillasEquipoLocal; i++)
                                {
                                    <div class="card-indicator card-yellow"></div>
                                }
                            </div>
                            <div class="team-info">
                                <span class="team-name">@partido.EquipoLocal</span>
                                <span class="team-logo">üèüÔ∏è</span>
                            </div>
                        </div>

                        <!-- Center: Score -->
                        <div class="match-center">
                            <div class="score-display">
                                <span class="score-local">@partido.GolesLocal</span>
                                <span class="score-separator">-</span>
                                <span class="score-visitante">@partido.GolesVisitante</span>
                            </div>
                        </div>

                        <!-- Right side: Visiting Team + Cards -->
                        <div class="match-right">
                            <div class="team-info">
                                <span class="team-logo">üèüÔ∏è</span>
                                <span class="team-name">@partido.EquipoVisitante</span>
                            </div>
                            <div class="cards-section cards-section-right cards-visitante">
                                @for (int i = 0; i < partido.AmarillasEquipoVisitante; i++)
                                {
                                    <div class="card-indicator card-yellow"></div>
                                }
                                @for (int i = 0; i < partido.RojasEquipoVisitante; i++)
                                {
                                    <div class="card-indicator card-red"></div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Goals Section - Separated by team -->
                    @if ((golesLocal.Any() || golesVisitante.Any()))
                    {
                        <div class="match-details">
                            <!-- Local Team Goals -->
                            <div class="team-goals">
                                <div class="goals-list goals-local">
                                    @if (golesLocal.Any())
                                    {
                                        @foreach (var gol in golesLocal)
                                        {
                                            <div class="goal-chip">
                                                <span class="goal-minute">'@gol.Minuto</span>
                                                <span class="goal-player">@gol.Jugador</span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="no-goals">Sin goles</span>
                                    }
                                </div>
                            </div>

                            <!-- Divider -->
                            <div class="goals-divider"></div>

                            <!-- Visiting Team Goals -->
                            <div class="team-goals">
                                <div class="goals-list goals-visitante">
                                    @if (golesVisitante.Any())
                                    {
                                        @foreach (var gol in golesVisitante)
                                        {
                                            <div class="goal-chip">
                                                <span class="goal-minute">'@gol.Minuto</span>
                                                <span class="goal-player">@gol.Jugador</span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="no-goals">Sin goles</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-matches">
            <h2>üìã No hay partidos disponibles</h2>
            <p>Los partidos aparecer√°n aqu√≠ cuando se programen</p>
        </div>
    }
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
<script>
    // SignalR Connection
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/promiedosHub")
        .withAutomaticReconnect()
        .build();

    // Handle card updates
    connection.on("TarjetasActualizadas", function (partidoId, equipo, amarillas, rojas) {
        console.log('Tarjetas actualizadas:', partidoId, equipo, amarillas, rojas);
        updateCardsUI(partidoId, equipo, amarillas, rojas);
        // Mostrar notificaci√≥n
        const teamName = equipo === 'local' ? 'Local' : 'Visitante';
        const message = `${teamName}: ${amarillas} amarilla(s), ${rojas} roja(s)`;
        showNotification('warning', 'Tarjetas actualizadas', message);
    });

    // Handle goal registration
    connection.on("GolRegistrado", function (partidoId, equipo, jugador, minuto, golesLocal, golesVisitante) {
        console.log('Gol registrado:', partidoId, equipo, jugador, minuto);
        updateScoreUI(partidoId, golesLocal, golesVisitante);
        addGoalToTeam(partidoId, equipo, jugador, minuto);
        // Mostrar notificaci√≥n
        const team = equipo === 'local' ? 'Local' : 'Visitante';
        const title = `Gol para ${team}`;
        const message = `${jugador} ‚Ä¢ Min ${minuto} ‚Äî ${golesLocal}-${golesVisitante}`;
        showNotification('success', title, message);
    });

    // Start connection
    connection.start()
        .then(() => {
            console.log('‚úÖ Conectado a Promiedos en tiempo real');
        })
        .catch(err => {
            console.error('‚ùå Error de conexi√≥n:', err);
            setTimeout(() => connection.start(), 5000);
        });

    // Update cards display
    function updateCardsUI(partidoId, equipo, amarillas, rojas) {
        const matchRow = document.querySelector(`[data-partido-id="${partidoId}"]`);
        if (!matchRow) return;

        const cardsContainer = matchRow.querySelector(`.cards-${equipo}`);
        if (!cardsContainer) return;

        // Clear and rebuild cards
        cardsContainer.innerHTML = '';

        // Add red cards first
        for (let i = 0; i < rojas; i++) {
            const redCard = document.createElement('div');
            redCard.className = 'card-indicator card-red';
            cardsContainer.appendChild(redCard);
        }

        // Add yellow cards
        for (let i = 0; i < amarillas; i++) {
            const yellowCard = document.createElement('div');
            yellowCard.className = 'card-indicator card-yellow';
            cardsContainer.appendChild(yellowCard);
        }
    }

    // Update score
    function updateScoreUI(partidoId, golesLocal, golesVisitante) {
        const matchRow = document.querySelector(`[data-partido-id="${partidoId}"]`);
        if (!matchRow) return;

        const scoreLocal = matchRow.querySelector('.score-local');
        const scoreVisitante = matchRow.querySelector('.score-visitante');

        if (scoreLocal) {
            scoreLocal.textContent = golesLocal;
            // Animate score change
            scoreLocal.style.transform = 'scale(1.3)';
            scoreLocal.style.color = '#ffd700';
            setTimeout(() => {
                scoreLocal.style.transform = 'scale(1)';
                scoreLocal.style.color = '#fff';
            }, 500);
        }

        if (scoreVisitante) {
            scoreVisitante.textContent = golesVisitante;
            // Animate score change
            scoreVisitante.style.transform = 'scale(1.3)';
            scoreVisitante.style.color = '#ffd700';
            setTimeout(() => {
                scoreVisitante.style.transform = 'scale(1)';
                scoreVisitante.style.color = '#fff';
            }, 500);
        }
    }

    // Add goal to respective team section
    function addGoalToTeam(partidoId, equipo, jugador, minuto) {
        const matchRow = document.querySelector(`[data-partido-id="${partidoId}"]`);
        if (!matchRow) return;

        // Get or create match details section
        let matchDetails = matchRow.querySelector('.match-details');
        if (!matchDetails) {
            matchDetails = document.createElement('div');
            matchDetails.className = 'match-details';
            
            // Create both team goal sections
            const localSection = createTeamGoalsSection('local');
            const divider = document.createElement('div');
            divider.className = 'goals-divider';
            const visitanteSection = createTeamGoalsSection('visitante');
            
            matchDetails.appendChild(localSection);
            matchDetails.appendChild(divider);
            matchDetails.appendChild(visitanteSection);
            matchRow.appendChild(matchDetails);
        }

        // Get the goals list for the specific team
        const goalsListClass = equipo === 'local' ? '.goals-local' : '.goals-visitante';
        const goalsList = matchRow.querySelector(goalsListClass);
        
        if (!goalsList) return;

        // Remove "no goals" message if exists
        const noGoalsMsg = goalsList.querySelector('.no-goals');
        if (noGoalsMsg) {
            noGoalsMsg.remove();
        }

        // Create goal chip
        const goalChip = document.createElement('div');
        goalChip.className = 'goal-chip';
        goalChip.style.opacity = '0';
        goalChip.innerHTML = `
            <span class="goal-minute">'${minuto}</span>
            <span class="goal-player">${jugador}</span>
        `;

        // Find correct position (sorted by minute)
        const existingGoals = Array.from(goalsList.querySelectorAll('.goal-chip'));
        let inserted = false;
        
        for (let i = 0; i < existingGoals.length; i++) {
            const existingMinute = parseInt(existingGoals[i].querySelector('.goal-minute').textContent.replace("'", ""));
            if (minuto < existingMinute) {
                goalsList.insertBefore(goalChip, existingGoals[i]);
                inserted = true;
                break;
            }
        }
        
        if (!inserted) {
            goalsList.appendChild(goalChip);
        }

        // Animate entrance
        setTimeout(() => {
            goalChip.style.transition = 'opacity 0.5s, transform 0.5s';
            goalChip.style.opacity = '1';
            goalChip.style.transform = 'scale(1)';
        }, 50);

        // Highlight new goal
        goalChip.style.backgroundColor = 'rgba(255, 215, 0, 0.3)';
        goalChip.style.borderColor = 'rgba(255, 215, 0, 0.6)';
        setTimeout(() => {
            goalChip.style.transition = 'background-color 1s, border-color 1s';
            goalChip.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            goalChip.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        }, 2000);
    }

    // Helper function to create team goals section
    function createTeamGoalsSection(equipo) {
        const teamGoals = document.createElement('div');
        teamGoals.className = 'team-goals';
        
        const goalsList = document.createElement('div');
        goalsList.className = `goals-list goals-${equipo}`;
        
        const noGoals = document.createElement('span');
        noGoals.className = 'no-goals';
        noGoals.textContent = 'Sin goles';
        goalsList.appendChild(noGoals);
        
        teamGoals.appendChild(goalsList);
        
        return teamGoals;
    }

    // Mostrar notificaci√≥n tipo toast
    function showNotification(type, title, message, timeout = 5000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = document.createElement('div');
        icon.className = 'icon';
        icon.textContent = type === 'success' ? '‚öΩ' : (type === 'warning' ? 'üü®' : '‚ÑπÔ∏è');

        const content = document.createElement('div');
        content.className = 'content';

        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = title;

        const m = document.createElement('div');
        m.className = 'message';
        m.textContent = message;

        content.appendChild(t);
        content.appendChild(m);

        toast.appendChild(icon);
        toast.appendChild(content);

        container.prepend(toast);

        // Force reflow then show
        requestAnimationFrame(() => {
            toast.classList.add('show');
        });

        // Auto remove
        const remove = () => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        };

        const timer = setTimeout(remove, timeout);

        // Allow manual dismiss on click
        toast.addEventListener('click', () => {
            clearTimeout(timer);
            remove();
        });
    }

    // Handle reconnection
    connection.onreconnected(() => {
        console.log('üîÑ Reconectado a Promiedos');
        location.reload();
    });

    connection.onclose(() => {
        console.log('‚ö†Ô∏è Conexi√≥n cerrada. Intentando reconectar...');
        setTimeout(() => connection.start(), 5000);
    });
</script>
