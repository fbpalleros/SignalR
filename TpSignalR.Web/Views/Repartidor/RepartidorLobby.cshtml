@using TpSignalR.Web.Models
@{
    ViewData["Title"] = "Repartidor Lobby";
    Layout = "~/Views/Shared/_InicioLayout.cshtml";
}

<div class="repartidor-lobby-container">
    <h2 class="titulo">📦 Pedidos disponibles</h2>
    <p class="subtitulo">Los pedidos que aún buscan repartidor aparecerán aquí en tiempo real</p>

    @Html.AntiForgeryToken()

    <div class="table-wrapper">
        <table class="tabla-pedidos" id="pedidos-disponibles">
            <thead>
                <tr>
                    <th>ID Pedido</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Usuario</th>
                    <th>Producto</th>
                    <th>Categoria</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Filas agregadas vía SignalR -->
            </tbody>
        </table>
    </div>
</div>

<style>
    .titulo {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
        color: #00ffc8;
        text-shadow: 0 0 6px rgba(0,255,200,0.4);
    }

    .subtitulo {
        margin-bottom: 25px;
        color: #b8b8b8;
        font-size: 15px;
    }

    .table-wrapper {
        background: rgba(255,255,255,0.03);
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 0 25px rgba(0,0,0,0.6);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.06);
    }

    .tabla-pedidos {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 12px;
    }

        .tabla-pedidos thead tr {
            background: rgba(0,255,180,0.15);
            color: #00ffd0;
            text-shadow: 0 0 4px rgba(0,255,180,0.4);
        }

        .tabla-pedidos th, .tabla-pedidos td {
            padding: 14px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .tabla-pedidos tbody tr {
            background: rgba(255,255,255,0.02);
            transition: background 0.2s, transform 0.2s;
        }

            .tabla-pedidos tbody tr:hover {
                background: rgba(0,255,200,0.05);
                transform: scale(1.01);
            }

    .btn {
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        border: none;
    }

    .btn-success {
        background: #00d68f;
        color: #000;
        box-shadow: 0 0 8px rgba(0,214,143,0.5);
    }

        .btn-success:hover {
            background: #00ffb0;
            box-shadow: 0 0 12px rgba(0,255,176,0.7);
        }

    .btn-danger {
        background: #ff4f4f;
        color: #fff;
        box-shadow: 0 0 8px rgba(255,79,79,0.4);
    }

        .btn-danger:hover {
            background: #ff7070;
            box-shadow: 0 0 12px rgba(255,110,110,0.7);
        }

    .estado {
        font-weight: 600;
        color: #00ffd0;
    }

    .repartidor-lobby-container {
        padding: 30px;
        font-family: "Poppins", sans-serif;
        color: #fff;
        min-height: 100vh;
        background: linear-gradient(180deg, #111 0%, #000 100%);
    }


</style>

@section Scripts {
    <!-- tu script original sin modificar, igual que lo pasaste -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl('/notificationHub')
            .withAutomaticReconnect()
            .build();

        function renderPedidoRow(pedido) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-pedido-id', pedido.pedidoId);
            tr.innerHTML = `
                <td>${pedido.pedidoId}</td>
                <td>${pedido.total}</td>
                <td class="estado">${pedido.estado}</td>
                <td>${pedido.usuarioFinalId}</td>
                <td>${pedido.productoNombre}</td>
                <td>${pedido.productoCategoria}</td>
                <td>
                    <button class="btn btn-success aceptar">Aceptar</button>
                    <button class="btn btn-danger rechazar">Rechazar</button>
                </td>
            `;

            tr.querySelector('.aceptar').addEventListener('click', function () {
                const pedidoId = parseInt(tr.getAttribute('data-pedido-id'));
                const repartidorId = 3;
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                fetch('/Repartidor/AceptarPedido', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token || ''
                    },
                    body: JSON.stringify({ PedidoId: pedidoId, RepartidorId: repartidorId })
                }).then(res => {
                    if (res.ok) {
                        tr.remove();
                    } else if (res.status === 409) {
                        alert('Pedido ya no está disponible');
                        tr.remove();
                    } else {
                        res.text().then(t => console.error('Aceptar error:', res.status, t));
                        alert('Error aceptando pedido');
                    }
                });
            });

            tr.querySelector('.rechazar').addEventListener('click', function () {
                const pedidoId = parseInt(tr.getAttribute('data-pedido-id'));
                const repartidorId = 3;
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                fetch('/Repartidor/RechazarPedido', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token || ''
                    },
                    body: JSON.stringify({ PedidoId: pedidoId, RepartidorId: repartidorId })
                }).then(res => {
                    if (res.ok) {
                        alert('Pedido rechazado, permanece disponible');
                    } else {
                        res.text().then(t => console.error('Rechazar error:', res.status, t));
                        alert('Error rechazando pedido');
                    }
                });
            });

            return tr;
        }

        connection.on('NuevoPedido', function (pedido) {
            if (pedido.estado !== 'buscando repartidor') return;
            const tbody = document.querySelector('#pedidos-disponibles tbody');
            const row = renderPedidoRow(pedido);
            tbody.prepend(row);
        });

        connection.on('PedidoAceptado', function (pedidoId) {
            const row = document.querySelector(`tr[data-pedido-id='${pedidoId}']`);
            if (row) row.remove();
        });

        connection.start().then(function () {
            return connection.invoke('Register', 3);
        });
    </script>
}
