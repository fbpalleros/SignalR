@using TpSignalR.Web.Models
@{
    ViewData["Title"] = "Comercio Lobby";
    var pedidos = ViewBag.Pedidos as List<ComercioPedidoViewModel> ?? new List<ComercioPedidoViewModel>();
    var estados = new[] { "en preparación", "buscando repartidor", "en camino", "finalizada" };
}
@Html.AntiForgeryToken()
<div class="comercio-container">
    <div class="comercio-header">
        <h1>📦 Panel en Tiempo Real del Comercio</h1>
        <p>Visualizá tus pedidos y actualizá sus estados sin recargar la página</p>
    </div>
    <!-- === TARJETAS DE ESTADÍSTICAS === -->
    <div class="estadisticas-section">
        <div class="estadistica-card">
            <h3>Pedidos Totales</h3>
            <p id="totalPedidos">@pedidos.Count</p>
        </div>
        <div class="estadistica-card">
            <h3>Pedidos Activos</h3>
            <p id="pedidosActivos">@pedidos.Count(p => p.Estado != "finalizada")</p>
        </div>
        <div class="estadistica-card">
            <h3>Pedidos Finalizados</h3>
            <p id="pedidosFinalizados">@pedidos.Count(p => p.Estado == "finalizada")</p>
        </div>
    </div>
    <!-- === TABLA DE PEDIDOS === -->
    <div class="tabla-section">
        <h2>🧾 Pedidos Recientes</h2>
        <table class="tabla-pedidos">
            <thead>
                <tr>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Usuario Id</th>
                    <th>Producto</th>
                    <th>Categoría</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in pedidos)
                {
                    <tr>
                        <td>$@p.Total</td>
                        <td>
                            <select class="form-select pedido-estado" data-pedido-id="@p.PedidoId">
                                @foreach (var e in estados)
                                {
                                    <option value="@e" selected="@(e == p.Estado ? "selected" : null)">@e</option>
                                }
                            </select>
                        </td>
                        <td>@p.UsuarioFinalId</td>
                        <td>@p.ProductoNombre</td>
                        <td>@p.ProductoCategoria</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<!-- === ESTILOS === -->
<style>
    body {
        background-color: #0f0f0f;
        color: #eaeaea;
        font-family: 'Segoe UI', sans-serif;
    }

    .comercio-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px 40px;
        background-color: #111;
        border-radius: 12px;
        box-shadow: 0 0 25px rgba(0, 255, 204, 0.1);
    }

    .comercio-header {
        text-align: center;
        margin-bottom: 30px;
    }

        .comercio-header h1 {
            color: #00bfa6;
            margin-bottom: 10px;
        }

    .estadisticas-section {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: space-around;
        margin-bottom: 40px;
    }

    .estadistica-card {
        background-color: #1a1a1a;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        flex: 1;
        min-width: 200px;
        transition: transform 0.3s, background 0.3s;
    }

        .estadistica-card:hover {
            background-color: #222;
            transform: translateY(-4px);
        }

        .estadistica-card h3 {
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 10px;
        }

        .estadistica-card p {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ffcc;
        }

    .tabla-section {
        background-color: #1a1a1a;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 255, 204, 0.05);
    }

        .tabla-section h2 {
            color: #00bfa6;
            margin-bottom: 20px;
        }

    .tabla-pedidos {
        width: 100%;
        border-collapse: collapse;
    }

        .tabla-pedidos th, .tabla-pedidos td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .tabla-pedidos th {
            background-color: #00bfa6;
            color: #0f0f0f;
            font-weight: 600;
        }

        .tabla-pedidos tr:hover {
            background-color: #222;
            transition: 0.3s;
        }

    .form-select {
        background-color: #1a1a1a;
        color: #fff;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .highlight {
        background-color: rgba(0, 255, 204, 0.1);
        transition: background-color 0.5s ease-in-out;
    }
</style>
<!-- === SCRIPTS DE SIGNALR === -->
@section Scripts {
    <script>
            const comercioId = 1;
            const estados = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(estados));

            (function(){
                try {
                    if (!window.notificationConnection) {
                        console.warn('Global notificationConnection no está disponible, creando uno temporal...');
                        window.notificationConnection = new signalR.HubConnectionBuilder().withUrl('/notificationHub').build();
                        window.notificationConnection.start().then(function(){
                            window.notificationConnection.invoke('Register', comercioId).catch(function(err){ console.error('Register failed', err); });
                        }).catch(function(err){ console.error('Startup of temp connection failed', err); });
                    } else {
                        window.notificationConnection.invoke('Register', comercioId).catch(function(err){ console.error('Register failed', err); });
                    }

                    const nc = window.notificationConnection;

                    nc.on('NuevoPedido', function (pedido) {
                        console.log('🟡 NuevoPedido (shared connection) recibido:', pedido);
                        if (!pedido) return;

                        // Normalizar id de comercio y verificar destino
                        const comercioIdRecibido = pedido.comercioId ?? pedido.ComercioId ?? pedido.comercioID ?? pedido.Comercioid;
                        if (typeof comercioIdRecibido !== 'undefined' && comercioIdRecibido !== comercioId) return;

                        const pedidoId = pedido.pedidoId ?? pedido.PedidoId ?? '(sin id)';
                        const total = pedido.total ?? pedido.Total ?? '(sin total)';
                        const usuarioFinalId = pedido.usuarioFinalId ?? pedido.UsuarioFinalId ?? '(sin usuario)';
                        const productoNombre = pedido.productoNombre ?? pedido.ProductoNombre ?? '(sin nombre)';
                        const productoCategoria = pedido.productoCategoria ?? pedido.ProductoCategoria ?? '(sin categoría)';

                        // Si el payload no trae estado, asumimos 'en preparación' por defecto
                        const estadoRecibido = pedido.estado ?? pedido.Estado ?? estados[0];

                        // Construir options a partir del array de estados, marcando el seleccionado
                        const optionsHtml = estados.map(e =>
                            `<option value="${e}" ${e === estadoRecibido ? 'selected' : ''}>${e}</option>`
                        ).join('');

                        const tbody = document.querySelector('.tabla-pedidos tbody');
                        const tr = document.createElement('tr');
                        tr.classList.add('highlight');

                        tr.innerHTML = `
                            <td>$${total}</td>
                            <td>
                                <select class="form-select pedido-estado" data-pedido-id="${pedidoId}">
                                    ${optionsHtml}
                                </select>
                            </td>
                            <td>${usuarioFinalId}</td>
                            <td>${productoNombre}</td>
                            <td>${productoCategoria}</td>
                        `;

                        tbody.prepend(tr);
                        setTimeout(() => tr.classList.remove('highlight'), 2000);
                        actualizarEstadisticas();
                    });

                } catch (ex) {
                    console.error('Error inicializando handlers de NuevoPedido:', ex);
                }
            })();

            async function refreshPedidos() {
                try {
                    const res = await fetch(`/Comercio/GetPedidosJson?comercioId=${comercioId}`, { credentials: 'same-origin' });
                    if (!res.ok) return;
                    const lista = await res.json();
                    const tbody = document.querySelector('.tabla-pedidos tbody');
                    tbody.innerHTML = '';

                    lista.forEach(p => {
                        const optionsHtml = estados.map(e => `<option value="${e}" ${e === p.estado ? 'selected' : ''}>${e}</option>`).join('');
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>$${p.total}</td>
                            <td>
                                <select class="form-select pedido-estado" data-pedido-id="${p.pedidoId}">
                                    ${optionsHtml}
                                </select>
                            </td>
                            <td>${p.usuarioFinalId}</td>
                            <td>${p.productoNombre}</td>
                            <td>${p.productoCategoria}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    actualizarEstadisticas();
                } catch (err) {
                    console.error('Error refrescando pedidos:', err);
                }
            }

            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('pedido-estado')) {
                    const pedidoId = e.target.getAttribute('data-pedido-id');
                    const nuevoEstado = e.target.value;
                    fetch('/Comercio/ActualizarEstadoPedido', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify({ pedidoId: parseInt(pedidoId), nuevoEstado })
                    }).then(async res => {
                        if (res.ok) {
                            // server already sent notifications; refresh full list to reflect DB state
                            await refreshPedidos();
                        } else {
                            console.error('ActualizarEstadoPedido failed', res.status);
                        }
                    });
                }
            });

            function actualizarEstadisticas() {
                const total = document.querySelectorAll('.tabla-pedidos tbody tr').length;
                const enProceso = [...document.querySelectorAll('.pedido-estado')].filter(s => s.value !== "finalizada").length;
                const finalizados = total - enProceso;
                document.getElementById("totalPedidos").innerText = total;
                document.getElementById("pedidosActivos").innerText = enProceso;
                document.getElementById("pedidosFinalizados").innerText = finalizados;
            }
    </script>
}