@using TpSignalR.Web.Models
@{
    ViewData["Title"] = "Comercio Lobby";
    var pedidos = ViewBag.Pedidos as List<ComercioPedidoViewModel> ?? new List<ComercioPedidoViewModel>();
    var estados = new[] { "en preparación", "buscando repartidor", "en camino", "finalizada" };
}
@Html.AntiForgeryToken()

<div class="comercio-wrapper">
    <div class="comercio-header">
        <h1>📦 Panel del Comercio</h1>
        <p>Gestioná tus pedidos en tiempo real</p>
    </div>

    <!-- === TARJETAS === -->
    <div class="estadisticas-grid">
        <div class="stat-card">
            <h3>Pedidos Totales</h3>
            <p id="totalPedidos">@pedidos.Count</p>
        </div>
        <div class="stat-card">
            <h3>Pedidos Activos</h3>
            <p id="pedidosActivos">@pedidos.Count(p => p.Estado != "finalizada")</p>
        </div>
        <div class="stat-card">
            <h3>Pedidos Finalizados</h3>
            <p id="pedidosFinalizados">@pedidos.Count(p => p.Estado == "finalizada")</p>
        </div>
    </div>

    <!-- === TABLA === -->
    <div class="tabla-wrapper">
        <h2>🧾 Pedidos Recientes</h2>

        <table class="tabla neon-table">
            <thead>
                <tr>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Producto</th>
                    <th>Categoría</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in pedidos)
                {
                    <tr>
                        <td>$@p.Total</td>
                        <td>
                            <select class="form-select pedido-estado" data-pedido-id="@p.PedidoId">
                                @foreach (var e in estados)
                                {
                                    <option value="@e" selected="@(e == p.Estado ? "selected" : null)">@e</option>
                                }
                            </select>
                        </td>
                        <td>@p.ProductoNombre</td>
                        <td>@p.ProductoCategoria</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- === ESTILOS IGUALADOS === -->
<style>
    body {
        background: linear-gradient(180deg, #111 0%, #000 100%);
        color: #fff;
        font-family: "Poppins", sans-serif;
        overflow-x: hidden;
    }

    .comercio-wrapper {
        max-width: 1200px;
        margin: 40px auto;
        padding: 30px;
        background: rgba(255,255,255,0.03);
        border-radius: 16px;
        box-shadow: 0 0 25px rgba(0,255,200,0.08);
        border: 1px solid rgba(0,255,200,0.05);
        backdrop-filter: blur(6px);
    }

    .comercio-header {
        text-align: center;
        margin-bottom: 35px;
    }

        .comercio-header h1 {
            font-size: 32px;
            color: #00ffc8;
            text-shadow: 0 0 6px rgba(0,255,200,0.4);
            margin-bottom: 8px;
        }

        .comercio-header p {
            color: #b8b8b8;
        }

    /* === TARJETAS === */

    .estadisticas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: #1a1a1a;
        padding: 20px;
        border-radius: 14px;
        text-align: center;
        box-shadow: 0 0 12px rgba(0, 255, 200, 0.15);
        border: 1px solid rgba(0,255,200,0.05);
        transition: transform 0.3s, box-shadow 0.3s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 18px rgba(0,255,200,0.3);
        }

        .stat-card h3 {
            font-size: 1rem;
            color: #b8b8b8;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 2rem;
            font-weight: 700;
            color: #00ffc8;
            text-shadow: 0 0 8px rgba(0,255,200,0.5);
        }

    /* === TABLA === */

    .tabla-wrapper {
        background: rgba(255,255,255,0.03);
        padding: 25px;
        border-radius: 14px;
        border: 1px solid rgba(0,255,200,0.05);
        box-shadow: 0 0 20px rgba(0, 255, 200, 0.05);
    }

        .tabla-wrapper h2 {
            color: #00ffc8;
            margin-bottom: 20px;
            text-shadow: 0 0 6px rgba(0,255,200,0.4);
        }

    .neon-table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 12px;
    }

        .neon-table th {
            background: rgba(0,255,200,0.15);
            color: #00ffd0;
            padding: 14px;
            text-shadow: 0 0 4px rgba(0,255,200,0.4);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .neon-table td {
            padding: 14px;
            color: #e4e4e4;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .neon-table tbody tr {
            background: rgba(255,255,255,0.02);
            transition: 0.25s;
        }

            .neon-table tbody tr:hover {
                background: rgba(0,255,200,0.05);
                transform: scale(1.01);
            }

    /* === SELECT NEON CON ICONO === */

    .form-select,
    select.pedido-estado {
        width: 100%;
        padding: 10px 36px 10px 12px;
        font-size: 0.95rem;
        font-weight: 500;
        background: #0f0f0f;
        color: #00ffc8;
        border: 2px solid rgba(0,255,200,0.35);
        border-radius: 10px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
        /* === icono flecha (Heroicons) === */
        background-image: url("https://cdn-icons-png.flaticon.com/512/992/992207.png");
        background-repeat: no-repeat;
        background-size: 20px;
        background-position: right 10px center;
        transition: 0.25s ease;
    }

        .form-select:hover,
        select.pedido-estado:hover {
            border-color: #00ffc8;
            box-shadow: 0 0 12px rgba(0,255,200,0.45);
        }

        .form-select:focus,
        select.pedido-estado:focus {
            outline: none;
            border-color: #00ffc8;
            box-shadow: 0 0 15px rgba(0,255,200,0.65);
        }

        .form-select option,
        select.pedido-estado option {
            background: #0f0f0f;
            color: #00ffc8;
            padding: 10px;
        }

</style>

<!-- === SCRIPTS DE SIGNALR === -->
@section Scripts {
    <script>
            const comercioId = 1;
            const estados = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(estados));

            (function(){
                try {
                    if (!window.notificationConnection) {
                        console.warn('Global notificationConnection no está disponible, creando uno temporal...');
                        window.notificationConnection = new signalR.HubConnectionBuilder().withUrl('/notificationHub').build();
                        window.notificationConnection.start().then(function(){
                            window.notificationConnection.invoke('Register', comercioId).catch(function(err){ console.error('Register failed', err); });
                        }).catch(function(err){ console.error('Startup of temp connection failed', err); });
                    } else {
                        window.notificationConnection.invoke('Register', comercioId).catch(function(err){ console.error('Register failed', err); });
                    }

                    const nc = window.notificationConnection;

                    nc.on('NuevoPedido', function (pedido) {
                        console.log('🟡 NuevoPedido (shared connection) recibido:', pedido);
                        if (!pedido) return;

                        // Normalizar id de comercio y verificar destino
                        const comercioIdRecibido = pedido.comercioId ?? pedido.ComercioId ?? pedido.comercioID ?? pedido.Comercioid;
                        if (typeof comercioIdRecibido !== 'undefined' && comercioIdRecibido !== comercioId) return;

                        const pedidoId = pedido.pedidoId ?? pedido.PedidoId ?? '(sin id)';
                        const total = pedido.total ?? pedido.Total ?? '(sin total)';
                        const usuarioFinalId = pedido.usuarioFinalId ?? pedido.UsuarioFinalId ?? '(sin usuario)';
                        const productoNombre = pedido.productoNombre ?? pedido.ProductoNombre ?? '(sin nombre)';
                        const productoCategoria = pedido.productoCategoria ?? pedido.ProductoCategoria ?? '(sin categoría)';

                        // Si el payload no trae estado, asumimos 'en preparación' por defecto
                        const estadoRecibido = pedido.estado ?? pedido.Estado ?? estados[0];

                        // Construir options a partir del array de estados, marcando el seleccionado
                        const optionsHtml = estados.map(e =>
                            `<option value="${e}" ${e === estadoRecibido ? 'selected' : ''}>${e}</option>`
                        ).join('');

                        const tbody = document.querySelector('.tabla-pedidos tbody');
                        const tr = document.createElement('tr');
                        tr.classList.add('highlight');

                        tr.innerHTML = `
                            <td>$${total}</td>
                            <td>
                                <select class="form-select pedido-estado" data-pedido-id="${pedidoId}">
                                    ${optionsHtml}
                                </select>
                            </td>
                            <td>${usuarioFinalId}</td>
                            <td>${productoNombre}</td>
                            <td>${productoCategoria}</td>
                        `;

                        tbody.prepend(tr);
                        setTimeout(() => tr.classList.remove('highlight'), 2000);
                        actualizarEstadisticas();
                    });

                } catch (ex) {
                    console.error('Error inicializando handlers de NuevoPedido:', ex);
                }
            })();

            async function refreshPedidos() {
                try {
                    const res = await fetch(`/Comercio/GetPedidosJson?comercioId=${comercioId}`, { credentials: 'same-origin' });
                    if (!res.ok) return;
                    const lista = await res.json();
                    const tbody = document.querySelector('.tabla-pedidos tbody');
                    tbody.innerHTML = '';

                    lista.forEach(p => {
                        const optionsHtml = estados.map(e => `<option value="${e}" ${e === p.estado ? 'selected' : ''}>${e}</option>`).join('');
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>$${p.total}</td>
                            <td>
                                <select class="form-select pedido-estado" data-pedido-id="${p.pedidoId}">
                                    ${optionsHtml}
                                </select>
                            </td>
                            <td>${p.usuarioFinalId}</td>
                            <td>${p.productoNombre}</td>
                            <td>${p.productoCategoria}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    actualizarEstadisticas();
                } catch (err) {
                    console.error('Error refrescando pedidos:', err);
                }
            }

            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('pedido-estado')) {
                    const pedidoId = e.target.getAttribute('data-pedido-id');
                    const nuevoEstado = e.target.value;
                    fetch('/Comercio/ActualizarEstadoPedido', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify({ pedidoId: parseInt(pedidoId), nuevoEstado })
                    }).then(async res => {
                        if (res.ok) {
                            // server already sent notifications; refresh full list to reflect DB state
                            await refreshPedidos();
                        } else {
                            console.error('ActualizarEstadoPedido failed', res.status);
                        }
                    });
                }
            });

            function actualizarEstadisticas() {
                const total = document.querySelectorAll('.tabla-pedidos tbody tr').length;
                const enProceso = [...document.querySelectorAll('.pedido-estado')].filter(s => s.value !== "finalizada").length;
                const finalizados = total - enProceso;
                document.getElementById("totalPedidos").innerText = total;
                document.getElementById("pedidosActivos").innerText = enProceso;
                document.getElementById("pedidosFinalizados").innerText = finalizados;
            }
    </script>
}